# Azure Deployment Plan for Workday MCP Server Project

## **Goal**
Deploy the Python-based Workday MCP server to Azure Container Apps using Azure CLI and the existing Bicep template found under `infra/azure`.

## **Project Information**
- **App Name**: workday-mcp
- **Technology Stack**: Python 3.11, FastMCP (Starlette/uvicorn) HTTP transport
- **Application Type**: Stateless MCP server exposing Workday tools through HTTP
- **Containerization**: Multi-stage Dockerfile at `Dockerfile`; produces image listening on port 8080
- **Configuration**: Environment-driven via Pydantic settings with `.env` support; secrets stored outside source control
- **Hosting Recommendation**: Azure Container Apps with user-assigned managed identity and Azure Container Registry

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**
```mermaid
graph TD
    subgraph ResourceGroup
        ACR[(Azure Container Registry)]
        LAW[(Log Analytics Workspace)]
        CAE((Container Apps Environment))
        MI[(User Assigned Managed Identity)]
        ACA{{Azure Container App}}
    end
    KeyVault[(Azure Key Vault - optional)]
    MCPInspector[[MCP Inspector / Clients]]

    ACR --> ACA
    MI --> ACA
    ACA --> LAW
    CAE --> ACA
    ACA -->|HTTPS 443| MCPInspector
    KeyVault -. secrets .-> ACA
```

- Container image is built locally and pushed to Azure Container Registry.
- Azure Container App pulls the image from ACR, runs it within the Container Apps Environment, and exposes HTTPS ingress on port 8080.
- Managed identity assigned to the container app authenticates against Microsoft Graph / future services.
- Application logs flow into Log Analytics through the Container Apps environment.
- Optional Key Vault stores long-lived secrets (Workday refresh token, Graph client secret) referenced by the Container App.

## **Recommended Azure Resources**

Recommended App service hosting the project
- **Application**: Workday MCP Server
  - **Hosting Service Type**: Azure Container Apps
  - **SKU**: Consumption (default) with 1 vCPU / 2 GiB memory per replica (matches current template)
  - **Configuration**:
    - language: python
    - dockerFilePath: `Dockerfile`
    - dockerContext: project root (`.`)
    - Environment Variables (non-secret examples):
      - `MCP_SERVER=workday`
      - `WORKDAY_WORKERS_API_URL` (non-secret endpoint base)
      - `WORKDAY_TOKEN_URL`
      - `LOG_LEVEL` (optional)
      - `MCP_STREAMABLE_HTTP_PATH=/mcp/workday`
    - Use Container App secrets for sensitive values:
      - `WORKDAY_CLIENT_ID`, `WORKDAY_CLIENT_SECRET`, `WORKDAY_REFRESH_TOKEN`
      - `AAD_APP_CLIENT_ID`, `AAD_APP_TENANT_ID`
      - `GRAPH_CLIENT_SECRET`
  - **Dependencies**:
    - **Azure Container Registry (Standard SKU)**
      - Service Type: Container Registry
      - Connection Type: Managed identity with `AcrPull` role assignment
      - Environment Variables: `CONTAINER_IMAGE=<acr>.azurecr.io/workday-mcp:<tag>`
    - **Azure Log Analytics Workspace (PerGB2018 SKU)**
      - Service Type: Log Analytics
      - Connection Type: Automatically linked via Container Apps environment
      - Environment Variables: none required

Recommended Supporting Services
- Application Insights (optional add-on via Log Analytics workspace integration)
- Azure Key Vault (optional but recommended) to store long-lived refresh tokens and client secrets, referenced as Container App secrets
- Container Registry (required for container image hosting)

Recommended Security Configurations
- Assign a user-managed identity (`<containerAppName>-id`) to the container app, scoped for Microsoft Graph and Workday API access.
- Grant the managed identity `AcrPull` role (`7f951dda-4ed3-4680-a7ca-43fe172d538d`) on the Container Registry.
- Store sensitive configuration in Container App secrets or Key Vault; never bake secrets into the image.
- Restrict inbound traffic using Container App ingress settings once testing is complete (e.g., IP allow list or Front Door).

## **Execution Step**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan.**
1. Provision Azure Infrastructure:
    1. Review `infra/azure/containerapp.bicep` and `parameters.example.json`; derive deployment parameters for the target environment.
    2. Generate Azure CLI commands (`az deployment group`) that deploy Log Analytics, Container Apps Environment, Container App, Managed Identity, and supporting resources.
    3. Run `az deployment group what-if` to preview changes, then `az deployment group create` to provision resources, confirming each succeeds.

2. Build and Deploy the Application:
    1. Build Docker image locally using `docker build -t workday-mcp .` (Dockerfile already present) and validate with `docker run` against MCP Inspector.
    2. Tag and push the image to the Azure Container Registry (`docker tag` + `docker push`).
    3. Update deployment parameters with the pushed image reference and run an `az containerapp update` if needed to roll out the new revision.

3. Validation:
    1. Confirm deployment outputs: Container App FQDN and managed identity client ID.
    2. Access `https://<app>.<region>.azurecontainerapps.io/mcp/workday` from MCP Inspector with a valid Authorization header to verify tool registration.

4. Summary:
    1. Document provisioning and deployment results, updating `.azure/summary.copilotmd` with resource list, image tag, and validation status. Include an architecture diagram of provisioned resources.
